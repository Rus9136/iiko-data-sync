{% extends "base.html" %}

{% block title %}Чек {{ sale.fiscal_cheque_number or sale.order_num }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Навигация -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Главная</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('sales') }}">Продажи</a></li>
            <li class="breadcrumb-item active">Чек {{ sale.fiscal_cheque_number or sale.order_num }}</li>
        </ol>
    </nav>

    <!-- Заголовок -->
    <div class="row mb-4">
        <div class="col">
            <h1>Чек № {{ sale.fiscal_cheque_number or sale.order_num }}</h1>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('sales') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Назад к списку
            </a>
        </div>
    </div>

    <!-- Информация о чеке -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Основная информация</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th style="width: 40%;">Номер заказа:</th>
                            <td>{{ sale.order_num }}</td>
                        </tr>
                        <tr>
                            <th>Номер чека:</th>
                            <td>{{ sale.fiscal_cheque_number or 'Не указан' }}</td>
                        </tr>
                        <tr>
                            <th>Дата закрытия:</th>
                            <td>
                                {% if sale.close_time %}
                                {{ sale.close_time.strftime('%d.%m.%Y %H:%M:%S') }}
                                {% else %}
                                <span class="text-muted">Не указана</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Дата предчека:</th>
                            <td>
                                {% if sale.precheque_time %}
                                {{ sale.precheque_time.strftime('%d.%m.%Y %H:%M:%S') }}
                                {% else %}
                                <span class="text-muted">Не указана</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Тип оплаты:</th>
                            <td>{{ sale.pay_types or 'Не указано' }}</td>
                        </tr>
                        <tr>
                            <th>Статус:</th>
                            <td>
                                {% if sale.storned == True %}
                                <span class="badge bg-danger">Отменен</span>
                                {% elif sale.deleted_with_writeoff == 'NOT_DELETED' and sale.dish_return_sum is not none and sale.dish_return_sum > 0 %}
                                <span class="badge bg-warning">Возврат</span>
                                {% elif sale.deleted_with_writeoff == 'NOT_DELETED' %}
                                <span class="badge bg-success">Активный</span>
                                {% elif sale.deleted_with_writeoff == 'DELETED_WITH_WRITEOFF' %}
                                <span class="badge bg-warning">Удален со списанием</span>
                                {% elif sale.deleted_with_writeoff == 'DELETED_WITHOUT_WRITEOFF' %}
                                <span class="badge bg-danger">Удален без списания</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ sale.deleted_with_writeoff }}</span>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Торговая точка</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th style="width: 40%;">Подразделение:</th>
                            <td>{{ sale.department or 'Не указано' }}</td>
                        </tr>
                        <tr>
                            <th>Склад:</th>
                            <td>{{ sale.store_name or 'Не указано' }}</td>
                        </tr>
                        <tr>
                            <th>Касса:</th>
                            <td>{{ sale.cash_register_name or 'Не указано' }}</td>
                        </tr>
                        <tr>
                            <th>Номер кассы:</th>
                            <td>{{ sale.cash_register_number or 'Не указано' }}</td>
                        </tr>
                        <tr>
                            <th>Серийный номер:</th>
                            <td>{{ sale.cash_register_serial_number or 'Не указано' }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Статистика чека -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary">{{ order_items_count }}</h3>
                    <p class="card-text">Позиций в чеке</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success">{{ "%.3f"|format(total_sum) }} ₸</h3>
                    <p class="card-text">Общая сумма</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning">{{ "%.3f"|format(total_discount) }} ₸</h3>
                    <p class="card-text">Скидки</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info">{{ "%.3f"|format(total_increase) }} ₸</h3>
                    <p class="card-text">Наценки</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Позиции чека -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Позиции чека ({{ order_items_count }})</h5>
        </div>
        <div class="card-body">
            {% if related_sales %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>№</th>
                            <th>Код товара</th>
                            <th>Наименование</th>
                            <th>Количество</th>
                            <th>Ед. изм.</th>
                            <th>Цена за ед.</th>
                            <th>Скидка</th>
                            <th>Возврат</th>
                            <th>Сумма</th>
                            <th>Наценка</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for related in related_sales %}
                        <tr {% if related.id == sale.id %}class="table-warning"{% endif %}>
                            <td>{{ loop.index }}</td>
                            <td>
                                {% if related.dish_code %}
                                <code>{{ related.dish_code }}</code>
                                {% else %}
                                <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td>
                                <strong>{{ related.dish_name }}</strong>
                                {% if related.id == sale.id %}
                                <span class="badge bg-primary ms-2">Текущая позиция</span>
                                {% endif %}
                            </td>
                            <td>{{ related.dish_amount }}</td>
                            <td>{{ related.dish_measure_unit or '—' }}</td>
                            <td>
                                {% if related.dish_sum is not none and related.dish_amount is not none and related.dish_amount > 0 %}
                                {{ "%.3f"|format(related.dish_sum / related.dish_amount) }} ₸
                                {% else %}
                                0.000 ₸
                                {% endif %}
                            </td>
                            <td>{{ "%.3f"|format(related.dish_discount_sum or 0) }} ₸</td>
                            <td>{{ "%.3f"|format(related.dish_return_sum or 0) }} ₸</td>
                            <td class="fw-bold">{{ "%.3f"|format(related.dish_sum or 0) }} ₸</td>
                            <td>{{ "%.3f"|format(related.increase_sum or 0) }} ₸</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="table-info">
                            <th colspan="6">Итого:</th>
                            <th>{{ "%.3f"|format(total_discount) }} ₸</th>
                            <th>{{ "%.3f"|format(total_return) }} ₸</th>
                            <th>{{ "%.3f"|format(total_sum) }} ₸</th>
                            <th>{{ "%.3f"|format(total_increase) }} ₸</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="bi bi-inbox" style="font-size: 3rem; color: #6c757d;"></i>
                <p class="text-muted mt-2">В чеке нет позиций</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}