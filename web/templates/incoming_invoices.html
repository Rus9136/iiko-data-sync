{% extends "base.html" %}

{% block title %}Приходные накладные - IIKO Data Sync{% endblock %}

{% block content %}
<div id="content-container">
    {% include 'incoming_invoices_content.html' %}
</div>
{% endblock %}

{% block scripts %}
<script>
function loadPage(page) {
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('page', page);
    
    fetch(`/incoming_invoices?${urlParams.toString()}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.text())
    .then(html => {
        document.getElementById('content-container').innerHTML = html;
        window.scrollTo(0, 0);
    })
    .catch(error => {
        console.error('Error loading page:', error);
    });
}

function filterInvoices() {
    const search = document.getElementById('searchInput').value;
    const dateFrom = document.getElementById('dateFromInput').value;
    const dateTo = document.getElementById('dateToInput').value;
    const supplierId = document.getElementById('supplierFilter').value;
    
    const params = new URLSearchParams({
        search: search,
        date_from: dateFrom,
        date_to: dateTo,
        supplier_id: supplierId,
        page: 1
    });
    
    fetch(`/incoming_invoices?${params.toString()}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.text())
    .then(html => {
        document.getElementById('content-container').innerHTML = html;
    })
    .catch(error => {
        console.error('Error filtering invoices:', error);
    });
}

function syncInvoices() {
    const dateFrom = document.getElementById('syncDateFrom').value;
    const dateTo = document.getElementById('syncDateTo').value;
    const supplierId = document.getElementById('syncSupplier').value;
    
    if (!dateFrom || !dateTo) {
        alert('Пожалуйста, укажите период');
        return;
    }
    
    if (!supplierId) {
        alert('Пожалуйста, выберите поставщика');
        return;
    }
    
    const syncButton = document.querySelector('.btn-sync');
    const originalText = syncButton.innerHTML;
    syncButton.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Синхронизация...';
    syncButton.disabled = true;
    
    fetch('/incoming_invoices/sync', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            from_date: dateFrom,
            to_date: dateTo,
            supplier_id: supplierId
        })
    })
    .then(response => response.json())
    .then(data => {
        syncButton.innerHTML = originalText;
        syncButton.disabled = false;
        
        if (data.status === 'success') {
            alert(data.message);
            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('syncModal'));
            modal.hide();
            // Перезагружаем страницу
            filterInvoices();
        } else {
            alert('Ошибка: ' + data.message);
        }
    })
    .catch(error => {
        syncButton.innerHTML = originalText;
        syncButton.disabled = false;
        alert('Ошибка при синхронизации: ' + error.message);
    });
}

// Обработчики для Enter в полях поиска
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                filterInvoices();
            }
        });
    }
});
</script>

<style>
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.spin {
    animation: spin 1s linear infinite;
    display: inline-block;
}
</style>
{% endblock %}